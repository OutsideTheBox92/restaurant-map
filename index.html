<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Prospektering – Restauranger & kaféer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }

    header {
      padding: 0.75rem 1rem;
      background: #1f2933;
      color: #fff;
    }

    #controls {
      padding: 0.75rem 1rem;
      background: #ffffff;
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-end;
      border-bottom: 1px solid #e0e0e0;
    }

    .control-block { display: flex; flex-direction: column; gap: 0.25rem; }
    .type-options { display: flex; gap: 0.75rem; flex-wrap: wrap; }

    #map-and-panel {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      height: calc(100vh - 140px);
    }

    #map { width: 100%; height: 100%; }

    #details {
      background: #ffffff;
      border-left: 1px solid #e0e0e0;
      padding: 1rem;
      overflow-y: auto;
    }

    .tag { padding: 4px 8px; border-radius: 999px; background: #f3f4f6; border: 1px solid #e5e7eb; font-size: 12px; }

    @media (max-width: 900px) {
      #map-and-panel { grid-template-columns: 1fr; grid-template-rows: 50vh auto; }
      #details { border-left: none; border-top: 1px solid #e0e0e0; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Prospektering – Restauranger & kaféer</h1>
    <p>Filtrera och klicka på en markör för detaljer.</p>
  </header>

  <section id="controls">
    <div class="control-block">
      <label>Typ av plats</label>
      <div class="type-options">
        <label><input type="radio" name="placeType" value="all" checked /> Alla</label>
        <label><input type="radio" name="placeType" value="restaurant" /> Restauranger</label>
        <label><input type="radio" name="placeType" value="cafe" /> Kaféer</label>
      </div>
    </div>

    <div class="control-block">
      <label for="minRating">Minsta betyg</label>
      <select id="minRating">
        <option value="0">Inget filter</option>
        <option value="3">3.0+</option>
        <option value="3.5">3.5+</option>
        <option value="4">4.0+</option>
        <option value="4.5">4.5+</option>
      </select>
    </div>

    <div class="control-block">
      <label for="minReviews">Minsta antal omdömen</label>
      <input id="minReviews" type="number" min="0" value="0" />
    </div>

    <div class="control-block">
      <label for="priceFilter">Prisnivå</label>
      <select id="priceFilter">
        <option value="all">Alla</option>
        <option value="low">Billig (0–1)</option>
        <option value="medium">Medel (2)</option>
        <option value="high">Dyr (3–4)</option>
      </select>
    </div>

  </section>

  <div id="map-and-panel">
    <div id="map"></div>

    <aside id="details">
      <h2 id="placeTitle">Ingen plats vald</h2>
      <p id="placeAddress"></p>
      <div id="placeMeta"><p>Välj en markör i kartan för att se detaljer.</p></div>
      <div id="tagRow" style="display:flex;gap:6px;flex-wrap:wrap;margin-top:12px;"></div>
    </aside>
  </div>

  <script>
    let map, placesService, infoWindow;
    let markers = [];

    let currentTypeFilter = "all";
    let minRating = 0;
    let minReviews = 0;
    let priceFilter = "all";

    const titleEl = document.getElementById("placeTitle");
    const addressEl = document.getElementById("placeAddress");
    const metaEl = document.getElementById("placeMeta");
    const tagRowEl = document.getElementById("tagRow");

    // Filter listeners
    document.querySelectorAll('input[name="placeType"]').forEach(r =>
      r.addEventListener("change", e => { currentTypeFilter = e.target.value; updateMarkers(); })
    );

    document.getElementById("minRating").addEventListener("change", e => {
      minRating = parseFloat(e.target.value);
      updateMarkers();
    });

    document.getElementById("minReviews").addEventListener("input", e => {
      minReviews = parseInt(e.target.value || "0", 10);
      updateMarkers();
    });

    document.getElementById("priceFilter").addEventListener("change", e => {
      priceFilter = e.target.value;
      updateMarkers();
    });

    function initMap() {
      const center = { lat: 59.334, lng: 18.063 };

      map = new google.maps.Map(document.getElementById("map"), {
        center, zoom: 13
      });

      placesService = new google.maps.places.PlacesService(map);
      infoWindow = new google.maps.InfoWindow();

      loadPlaces(center);

      map.addListener("idle", () => {
        const c = map.getCenter();
        loadPlaces({ lat: c.lat(), lng: c.lng() }, true);
      });
    }

    function loadPlaces(center, replace = false) {
      if (replace) { clearMarkers(); }

      const requests = [
        { location: center, radius: 2000, type: "restaurant" },
        { location: center, radius: 2000, type: "cafe" },
      ];

      requests.forEach(req => {
        placesService.nearbySearch(req, (results, status) => {
          if (status !== google.maps.places.PlacesServiceStatus.OK) return;

          results.forEach(place => {
            if (!place.geometry) return;

            const obj = {
              id: place.place_id,
              name: place.name,
              type: req.type,
              rating: place.rating ?? null,
              reviews: place.user_ratings_total ?? null,
              price: place.price_level ?? null,
              location: place.geometry.location,
              address: place.vicinity ?? null,
              opening_hours: place.opening_hours ?? null,
              detailsLoaded: false
            };

            const marker = new google.maps.Marker({
              map,
              position: place.geometry.location
            });

            marker.addListener("click", () => showPlace(obj, marker));

            markers.push({ marker, obj });
          });

          updateMarkers();
        });
      });
    }

    function updateMarkers() {
      markers.forEach(({ marker, obj }) => {
        let v = true;

        if (currentTypeFilter !== "all" && obj.type !== currentTypeFilter) v = false;
        if (minRating > 0 && (!obj.rating || obj.rating < minRating)) v = false;
        if (minReviews > 0 && (!obj.reviews || obj.reviews < minReviews)) v = false;

        if (priceFilter !== "all") {
          if (obj.price == null) v = false;
          else if (priceFilter === "low" && obj.price > 1) v = false;
          else if (priceFilter === "medium" && obj.price !== 2) v = false;
          else if (priceFilter === "high" && obj.price < 3) v = false;
        }

        marker.setVisible(v);
      });
    }

    function showPlace(obj, marker) {
      titleEl.textContent = obj.name;
      addressEl.textContent = obj.address ?? "";

      metaEl.innerHTML = `
        <p><b>Betyg:</b> ${obj.rating ?? "—"} (${obj.reviews ?? 0} omdömen)</p>
        <p><b>Prisnivå:</b> ${obj.price ?? "—"}</p>
        <p><b>Öppettider:</b><br>${formatHours(obj.opening_hours)}</p>
      `;

      tagRowEl.innerHTML = "";
      if (obj.rating >= 4.5) tagRowEl.innerHTML += `<span class="tag">Topprankad</span>`;
      if (obj.reviews >= 200) tagRowEl.innerHTML += `<span class="tag">Många omdömen</span>`;
      if (obj.price >= 3) tagRowEl.innerHTML += `<span class="tag">Högre pris</span>`;
      if (obj.price <= 1) tagRowEl.innerHTML += `<span class="tag">Billigt</span>`;

      infoWindow.setContent(`<div><b>${obj.name}</b><br>${obj.address ?? ""}</div>`);
      infoWindow.open(map, marker);
    }

    function clearMarkers() {
      markers.forEach(({ marker }) => marker.setMap(null));
      markers = [];
    }

    function formatHours(open) {
      if (!open || !open.weekday_text) return "Saknas";
      return open.weekday_text.join("<br>");
    }
  </script>

  <!-- Google Maps API med din nyckel -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGWBVPiQLze9-6NBDsCW3MI_UuvQ8SbbE&libraries=places&callback=initMap" async defer></script>
</body>
</html>
