<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Prospektering – Restauranger & kaféer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #222;
    }

    header {
      padding: 0.75rem 1rem;
      background: #1f2933;
      color: #fff;
    }

    header h1 { margin: 0; font-size: 1.1rem; }
    header p { margin: 0.25rem 0 0; font-size: 0.85rem; opacity: 0.85; }

    #controls {
      padding: 0.75rem 1rem;
      background: #ffffff;
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-end;
      border-bottom: 1px solid #e0e0e0;
    }

    .control-block { display: flex; flex-direction: column; gap: 0.25rem; }
    .type-options { display: flex; gap: 0.75rem; flex-wrap: wrap; }

    #map-and-panel {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      height: calc(100vh - 140px);
    }

    #map { width: 100%; height: 100%; }

    #details {
      background: #ffffff;
      border-left: 1px solid #e0e0e0;
      padding: 1rem;
      overflow-y: auto;
    }

    #placeTitle { font-size: 1.1rem; font-weight: 600; margin: 0; }
    #placeAddress { color: #555; margin: 0.2rem 0 0.5rem; }

    .tag { padding: 4px 8px; border-radius: 999px; background: #f3f4f6; border: 1px solid #e5e7eb; font-size: 12px; }

    @media (max-width: 900px) {
      #map-and-panel { grid-template-columns: 1fr; grid-template-rows: 50vh auto; }
      #details { border-left: none; border-top: 1px solid #e0e0e0; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Prospektering – Restauranger & kaféer</h1>
    <p>Filtrera och klicka på en markör för detaljer.</p>
  </header>

  <section id="controls">
    <div class="control-block">
      <label>Typ av plats</label>
      <div class="type-options">
        <label><input type="radio" name="placeType" value="all" checked /> Alla</label>
        <label><input type="radio" name="placeType" value="restaurant" /> Restauranger</label>
        <label><input type="radio" name="placeType" value="cafe" /> Kaféer</label>
      </div>
    </div>

    <div class="control-block">
      <label for="minRating">Minsta betyg</label>
      <select id="minRating">
        <option value="0">Inget filter</option>
        <option value="3">3.0+</option>
        <option value="3.5">3.5+</option>
        <option value="4">4.0+</option>
        <option value="4.5">4.5+</option>
      </select>
    </div>

    <div class="control-block">
      <label for="minReviews">Minsta antal omdömen</label>
      <input id="minReviews" type="number" min="0" value="0" />
    </div>

    <div class="control-block">
      <label for="priceFilter">Prisnivå</label>
      <select id="priceFilter">
        <option value="all">Alla</option>
        <option value="low">Billig (0–1)</option>
        <option value="medium">Medel (2)</option>
        <option value="high">Dyr (3–4)</option>
      </select>
    </div>
  </section>

  <div id="map-and-panel">
    <div id="map"></div>

    <aside id="details">
      <h2 id="placeTitle">Ingen plats vald</h2>
      <p id="placeAddress"></p>
      <div id="placeMeta"><p>Välj en markör i kartan.</p></div>

      <div id="tagRow" style="display:flex; gap:6px; flex-wrap:wrap; margin-top:12px;"></div>
    </aside>
  </div>

  <script>
    const GOOGLE_API_KEY = "AIzaSyAGWBVPiQLze9-6NBDsCW3MI_UuvQ8SbbE";

    let map, placesService, infoWindow;
    let markers = [];
    const loadedPlaceIds = new Set();

    let currentTypeFilter = "all";
    let minRating = 0;
    let minReviews = 0;
    let priceFilter = "all";

    const titleEl = document.getElementById("placeTitle");
    const addressEl = document.getElementById("placeAddress");
    const metaEl = document.getElementById("placeMeta");
    const tagRowEl = document.getElementById("tagRow");

    // Filters
    document.querySelectorAll('input[name="placeType"]').forEach(r =>
      r.addEventListener("change", e => {
        currentTypeFilter = e.target.value;
        updateMarkers();
      })
    );
    document.getElementById("minRating").addEventListener("change", e => {
      minRating = parseFloat(e.target.value);
      updateMarkers();
    });
    document.getElementById("minReviews").addEventListener("input", e => {
      minReviews = parseInt(e.target.value || "0");
      updateMarkers();
    });
    document.getElementById("priceFilter").addEventListener("change", e => {
      priceFilter = e.target.value;
      updateMarkers();
    });

    // -------- INIT MAP --------
    function initMap() {
      const center = { lat: 59.334, lng: 18.063 };

      map = new google.maps.Map(document.getElementById("map"), {
        center,
        zoom: 14,
      });

      placesService = new google.maps.places.PlacesService(map);
      infoWindow = new google.maps.InfoWindow();

      loadNearbyPlaces(center);

      map.addListener("idle", () => {
        const c = map.getCenter();
        if (!c) return;
        loadNearbyPlaces({ lat: c.lat(), lng: c.lng() });
      });
    }

    // -------- LOAD PLACES WITH PAGINATION --------
    function loadNearbyPlaces(center) {
      const requests = [
        { location: center, radius: 2000, type: "restaurant" },
        { location: center, radius: 2000, type: "cafe" },
      ];

      requests.forEach(req => {
        function handleResults(results, status, pagination) {
          if (status !== google.maps.places.PlacesServiceStatus.OK) return;

          results.forEach(place => {
            if (!place.geometry) return;
            if (loadedPlaceIds.has(place.place_id)) return;

            loadedPlaceIds.add(place.place_id);

            const placeObj = {
              id: place.place_id,
              name: place.name,
              type: req.type,
              location: place.geometry.location,
              rating: place.rating ?? null,
              user_ratings_total: place.user_ratings_total ?? null,
              price_level: place.price_level ?? null,
              basicAddress: place.vicinity ?? "",
              formatted_address: null,
              formatted_phone_number: null,
              opening_hours: place.opening_hours ?? null,
              website: null,
              detailsLoaded: false,
            };

            createMarker(placeObj);
            fetchPlaceDetails(placeObj);
          });

          updateMarkers();

          if (pagination && pagination.hasNextPage) {
            setTimeout(() => pagination.nextPage(), 500);
          }
        }

        placesService.nearbySearch(req, handleResults);
      });
    }

    // -------- GET DETAILS --------
    function fetchPlaceDetails(obj) {
      placesService.getDetails(
        {
          placeId: obj.id,
          fields: [
            "name",
            "formatted_address",
            "formatted_phone_number",
            "opening_hours",
            "website",
            "geometry",
            "rating",
            "user_ratings_total",
            "price_level",
          ],
        },
        (res, status) => {
          if (status !== "OK" || !res) return;

          obj.detailsLoaded = true;
          obj.name = res.name || obj.name;
          obj.formatted_address = res.formatted_address || obj.basicAddress;
          obj.formatted_phone_number = res.formatted_phone_number || null;
          obj.opening_hours = res.opening_hours || obj.opening_hours;
          obj.website = res.website || null;
          obj.rating = res.rating ?? obj.rating;
          obj.user_ratings_total = res.user_ratings_total ?? obj.user_ratings_total;
          obj.price_level = res.price_level ?? obj.price_level;
        }
      );
    }

    // -------- CREATE MARKER --------
    function createMarker(obj) {
      const icon =
        obj.type === "restaurant"
          ? { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#d32f2f", fillOpacity: 1, strokeWeight: 1 }
          : { path: google.maps.SymbolPath.CIRCLE, scale: 7, fillColor: "#1976d2", fillOpacity: 1, strokeWeight: 1 };

      const marker = new google.maps.Marker({
        map,
        position: obj.location,
        icon,
      });

      marker.addListener("click", () => {
        showInfoWindow(obj, marker);
        renderDetails(obj);
      });

      markers.push({ marker, obj });
    }

    // -------- UPDATE VISIBILITY --------
    function updateMarkers() {
      markers.forEach(({ marker, obj }) => {
        let visible = true;

        if (currentTypeFilter !== "all" && obj.type !== currentTypeFilter) visible = false;
        if (minRating > 0 && (!obj.rating || obj.rating < minRating)) visible = false;
        if (minReviews > 0 && (!obj.user_ratings_total || obj.user_ratings_total < minReviews)) visible = false;

        if (priceFilter !== "all") {
          const p = obj.price_level;
          if (p == null) visible = false;
          else if (priceFilter === "low" && p > 1) visible = false;
          else if (priceFilter === "medium" && p !== 2) visible = false;
          else if (priceFilter === "high" && p < 3) visible = false;
        }

        marker.setVisible(visible);
      });
    }

    // -------- INFO WINDOW --------
    function showInfoWindow(obj, marker) {
      const sv =
        "https://maps.googleapis.com/maps/api/streetview?size=320x160&location=" +
        obj.location.lat() +
        "," +
        obj.location.lng() +
        "&key=" +
        GOOGLE_API_KEY;

      const html = `
        <div style="font-size:0.85rem;max-width:260px">
          <b>${obj.name}</b><br/>
          ${obj.formatted_address ?? obj.basicAddress}<br/>
          <br/>
          <img src="${sv}" style="width:100%;border-radius:6px"/>
        </div>
      `;

      infoWindow.setContent(html);
      infoWindow.open(map, marker);
    }

    // -------- DETAILS PANEL --------
    function renderDetails(obj) {
      titleEl.textContent = obj.name;
      addressEl.textContent = obj.formatted_address ?? obj.basicAddress;

      const rating =
        obj.rating != null
          ? obj.rating.toFixed(1) + " (" + obj.user_ratings_total + " omdömen)"
          : "Inga betyg";

      const price =
        obj.price_level == null
          ? "Okänd"
          : obj.price_level === 0 || obj.price_level === 1
          ? "Billigt"
          : obj.price_level === 2
          ? "Medel"
          : "Dyrt";

      const phone = obj.formatted_phone_number ?? "Okänd";

      const hours = obj.opening_hours?.weekday_text
        ? obj.opening_hours.weekday_text.join("<br>")
        : "Ingen information";

      metaEl.innerHTML = `
        <p><b>Betyg:</b> ${rating}</p>
        <p><b>Prisnivå:</b> ${price}</p>
        <p><b>Telefon:</b> ${phone}</p>
        <p><b>Öppettider:</b><br>${hours}</p>
      `;
    }

    window.initMap = initMap;
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGWBVPiQLze9-6NBDsCW3MI_UuvQ8SbbE&libraries=places&callback=initMap"
    async defer></script>
</body>
</html>
